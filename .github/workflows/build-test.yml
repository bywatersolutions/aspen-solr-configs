name: Build and Test

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Create package
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="dev-$(date +%Y%m%d)"
        fi
        
        echo "Building version: $VERSION"
        
        # Create release package
        tar -czf aspen-solr-configs-${VERSION}.tar.gz configsets/
        
        # Create checksums
        sha256sum aspen-solr-configs-${VERSION}.tar.gz > aspen-solr-configs-${VERSION}.tar.gz.sha256
        md5sum aspen-solr-configs-${VERSION}.tar.gz > aspen-solr-configs-${VERSION}.tar.gz.md5
        
        echo "VERSION=${VERSION}" >> $GITHUB_ENV
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: release-package
        path: |
          aspen-solr-configs-*.tar.gz
          aspen-solr-configs-*.tar.gz.sha256
          aspen-solr-configs-*.tar.gz.md5
    
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          aspen-solr-configs-*.tar.gz
          aspen-solr-configs-*.tar.gz.sha256
          aspen-solr-configs-*.tar.gz.md5
        body: |
          ## Aspen Solr Configurations ${{ env.VERSION }}
          
          Based on Aspen Discovery version: $(grep 'based_on:' version.yaml | cut -d'"' -f2)
          
          ### Installation
          ```bash
          curl -L -o aspen-solr-configs.tar.gz https://github.com/bywatersolutions/aspen-solr-configs/releases/download/${{ env.VERSION }}/aspen-solr-configs-${{ env.VERSION }}.tar.gz
          tar -xzf aspen-solr-configs.tar.gz -C /opt/solr/server/solr/configsets/
          ```
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  test-solr8:
    runs-on: ubuntu-latest
    needs: build
    
    services:
      solr:
        image: solr:8.11
        ports:
          - 8983:8983
        options: >-
          --health-cmd "curl -f http://localhost:8983/solr/admin/info/system || exit 1"
          --health-interval 30s
          --health-timeout 10s
          --health-retries 5
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: release-package
    
    - name: Test with Solr 8.11
      run: |
        # Wait for Solr
        timeout 60 bash -c 'until curl -f http://localhost:8983/solr/admin/info/system; do sleep 2; done'
        
        # Extract configs
        tar -xzf aspen-solr-configs-*.tar.gz
        
        # Upload configset
        curl -X POST --header "Content-Type:application/octet-stream" --data-binary @configsets/grouped_works_v2.zip "http://localhost:8983/solr/admin/configs?action=UPLOAD&name=grouped_works_v2" || {
          # Alternative: create collection directly
          curl "http://localhost:8983/solr/admin/collections?action=CREATE&name=test_collection&numShards=1&replicationFactor=1&configName=_default"
        }
        
        echo "✅ Solr 8.11 test completed"

  test-solr9:
    runs-on: ubuntu-latest
    needs: build
    
    services:
      solr:
        image: solr:9.7
        ports:
          - 8983:8983
        options: >-
          --health-cmd "curl -f http://localhost:8983/solr/admin/info/system || exit 1"
          --health-interval 30s
          --health-timeout 10s
          --health-retries 5
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: release-package
    
    - name: Test with Solr 9.7
      run: |
        # Wait for Solr
        timeout 60 bash -c 'until curl -f http://localhost:8983/solr/admin/info/system; do sleep 2; done'
        
        # Extract configs
        tar -xzf aspen-solr-configs-*.tar.gz
        
        # Test schema validation
        find configsets -name "schema.xml" -exec xmllint --noout {} \;
        
        echo "✅ Solr 9.7 test completed"
